<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Cuaca</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>

<body class="h-screen flex flex-col md:flex-row bg-gray-100">

    <!-- Konten utama (map) -->
    <main class="flex-1 p-4 md:p-6">
        <div id="map" class="w-full h-[300px] md:h-[500px] rounded-xl shadow"></div>
    </main>

    <!-- Sidebar -->
    <aside id="sidebar" 
        class="relative w-full md:w-[450px] bg-gradient-to-br from-blue-50 via-blue-100 to-blue-300 
               shadow-lg p-6 md:p-8 flex flex-col justify-start overflow-hidden">
        
        <!-- Bubble effect -->
        <div class="absolute top-10 left-16 w-24 h-24 md:w-40 md:h-40 bg-blue-400 rounded-full opacity-20 blur-3xl"></div>
        <div class="absolute bottom-6 right-6 w-32 h-32 md:w-52 md:h-52 bg-blue-500 rounded-full opacity-10 blur-2xl"></div>

        <!-- Form search -->
        <form method="POST" class="mb-6 flex flex-col sm:flex-row items-center gap-2 relative z-10">
            <input type="text" name="city" placeholder="🔍 Cari kota..."
            class="flex-1 px-4 py-2 rounded-full border border-gray-300 shadow-sm 
                   focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200 w-full sm:w-auto" required>
            
            <button type="submit"
            class="px-5 py-2 rounded-2xl bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-medium shadow-md 
                   hover:from-blue-600 hover:to-indigo-600 transform hover:scale-105 transition duration-200 w-full sm:w-auto">
            Cari
            </button>
        </form>

        <!-- Hasil cuaca -->
        <div id="weather-result" class="relative z-10">
            {% if weather %}
            <div class="p-6 text-white rounded-2xl"
                style="background: radial-gradient(circle at top left, #a0d1bf, #1b4fa2);">
                <h2 class="text-2xl md:text-4xl font-bold text-center">{{ weather.nama_kota }}</h2>
                <img src="http://openweathermap.org/img/wn/{{ weather.icon }}@4x.png"
                    alt="icon cuaca"
                    class="mx-auto w-24 h-24 md:w-32 md:h-32 filter brightness-150 saturate-200 hue-rotate-30">

                <div class="text-xl md:text-2xl capitalize text-center font-bold">{{ weather.kondisi }}</div>
                <p class="text-sm md:text-lg mt-1 text-center">{{ weather.tanggal }}</p>
                <p class="text-sm md:text-lg mt-1 text-center">{{ weather.jam }}</p>
                <p class="text-4xl md:text-5xl text-center font-bold mt-8 mb-6">{{ weather.suhu }}°C</p>
                <p class="mt-1 text-center">Kelembapan: {{ weather.kelembapan }}%</p>
            </div>
            {% else %}
                <h2 class="text-2xl font-semibold text-center">Pilih kota di map</h2>
            {% endif %}
        </div>
    </aside>

</body>

<script>
  // Inisialisasi map
  var map = L.map('map').setView([ -6.200000, 106.816666 ], 5); // default Indonesia

  // Gunakan tile layer OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Event klik untuk pasang pin
  map.on('click', function(e) {
    // Hapus pin lama
    if (window.lastMarker) {
      map.removeLayer(window.lastMarker);
    }

    // Pasang pin baru
    var marker = L.marker(e.latlng).addTo(map);
    window.lastMarker = marker;

    // Popup konfirmasi
    marker.bindPopup(`
      <button onclick="pilihKota(${e.latlng.lat}, ${e.latlng.lng})" class="px-2 py-1 bg-blue-500 text-white rounded">
        Pilih kota ini
      </button>
    `).openPopup();
  });

    function pilihKota(lat, lon) {
    // Step 1: Reverse Geocoding untuk dapat kabupaten/kota
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`)
        .then(res => res.json())
        .then(location => {
        let namaKota = location.address.county || 
                        location.address.city || 
                        location.address.town || 
                        location.address.village || "Tidak diketahui";

        // Step 2: Ambil data cuaca berdasarkan koordinat
        fetch(`/weather_by_coord?lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
            // Update hanya hasil cuaca
            document.getElementById("weather-result").innerHTML = `
                <div class="p-6 text-white rounded-2xl"
                    style="background: radial-gradient(circle at top left, #a0d1bf, #1b4fa2);">
                <h2 class="text-4xl font-bold text-center">${namaKota}</h2>
                <img src="http://openweathermap.org/img/wn/${data.icon}@4x.png"
                    alt="icon cuaca"
                    class="mx-auto w-32 h-32 filter brightness-150 saturate-200 hue-rotate-30">

                <div class="text-2xl capitalize text-center font-bold">${data.kondisi}</div>
                <p class="text-l mt-1 text-center">${data.tanggal}</p>
                <p class="text-5xl text-center font-bold mt-10 mb-8">${data.suhu}°C</p>
                <p class="mt-1 text-center">Kelembapan: ${data.kelembapan}%</p>
                </div>
            `;
            });
        });
    }

</script>

</html>
